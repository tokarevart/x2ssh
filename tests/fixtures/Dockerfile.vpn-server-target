FROM alpine:3.19

RUN apk add --no-cache \
    openssh \
    iproute2 \
    iptables \
    sudo \
    procps

RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh

COPY keys/id_ed25519.pub /root/.ssh/authorized_keys
RUN chmod 600 /root/.ssh/authorized_keys

RUN ssh-keygen -A

RUN echo "PermitRootLogin prohibit-password" >> /etc/ssh/sshd_config && \
    echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config && \
    echo "PasswordAuthentication no" >> /etc/ssh/sshd_config && \
    echo "AllowTcpForwarding yes" >> /etc/ssh/sshd_config

RUN echo "root ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/root

EXPOSE 22 8080 8081

CMD ["/bin/sh", "-c", "(while true; do nc -l -p 8080 -e cat; done) & (while true; do nc -ul -p 8081 -e cat; done) & exec /usr/sbin/sshd -D -e"]
